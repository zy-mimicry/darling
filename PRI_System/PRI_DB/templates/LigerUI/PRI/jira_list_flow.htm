<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>PRI_System: OEMPRI Manager</title>
	<meta http-equiv="X-UA-Compatible" content="IE=8"/>
    <link href="../LigerUI/lib/ligerUI/skins/Aqua/css/ligerui-all.css" rel="stylesheet" type="text/css" />
    <script src="../LigerUI/lib/jquery/jquery-1.9.0.min.js" type="text/javascript"></script>
    <link href="../LigerUI/lib/ligerUI/skins/ligerui-icons.css" rel="stylesheet" type="text/css" />
    <script src="../LigerUI/lib/ligerUI/js/core/base.js" type="text/javascript"></script>
    <script src="../LigerUI/lib/ligerUI/js/plugins/ligerGrid.js" type="text/javascript"></script> 
    <script src="../LigerUI/lib/ligerUI/js/plugins/ligerResizable.js" type="text/javascript"></script>
    <script src="../LigerUI/lib/ligerUI/js/plugins/ligerDialog.js" type="text/javascript"></script>
    <script src="../LigerUI/lib/ligerUI/js/plugins/ligerTextBox.js" type="text/javascript"></script>
    <script src="../LigerUI/lib/ligerUI/js/plugins/ligerCheckBox.js" type="text/javascript"></script>
    <script src="../LigerUI/lib/ligerUI/js/plugins/ligerComboBox.js" type="text/javascript"></script>
    <script src="../LigerUI/lib/ligerUI/js/plugins/ligerGrid.js" type="text/javascript"></script>
    <script src="../LigerUI/lib/ligerUI/js/plugins/ligerDateEditor.js" type="text/javascript"></script>
    <script src="../LigerUI/lib/ligerUI/js/plugins/ligerSpinner.js" type="text/javascript"></script>
    <script src="../LigerUI/lib/ligerUI/js/plugins/ligerListBox.js" type="text/javascript"></script>
    <script src="../LigerUI/lib/ligerUI/js/plugins/ligerButton.js" type="text/javascript"></script>
    <script src="../LigerUI/lib/ligerUI/js/core/inject.js" type="text/javascript"></script>
    <script src="../LigerUI/lib/ligerUI/js/plugins/ligerToolBar.js" type="text/javascript"></script>

    <!--script src="../CustomersData.js" type="text/javascript"></script-->
    <script type="text/javascript">
        var g;
        $(function () {
            g = $("#maingrid4").ligerGrid({
                columns: [
                { display: 'ID', name: 'id', align: 'left', width: 40},
                { display: 'Key', name: 'Key',  align: 'left', width: 95,
                    render: function (record, rowindex, value, column) {
                        myurl='https://issues.sierrawireless.com/browse/' + value ;
                        return "<a href='"+myurl+"' target=__blank>"+value+"</a>";
                    },
                },
                { display: 'Status', name: 'Status',  align: 'left', width: 80},
                { display: 'Assignee', name: 'Assignee',  align: 'left', width: 70, 
                    render: function (record, rowindex, value, column) { html = add_color(value, column.name); return html}},
                { display: 'Reporter', name: 'Reporter',  align: 'left', width: 70},
                { display: 'Created', name: 'CreatedDate',  align: 'left', width: 80},
                { display: 'Customers', name: 'Customers',  align: 'left', width: 100,
                    render: function (record, rowindex, value, column) {
                        return "<div id='message1' title='"+value+"' ondblclick='f_tip2(this.title);' >"+value+"</div>";
                    },
                },
                { display: 'SKU Tracker', name: 'ProjID',  align: 'left', width: 50,
                    render: function (record, rowindex, value, column) {
                        myurl='https://skutracker.sierrawireless.local/projects/' + value ;
                        return "<a href='"+myurl+"' target=__blank>"+value+"</a>";
                    },
                },
                { display: 'Agile', name: 'AgileID',  align: 'left', width: 90,
                    render: function (item) {
                        myurl=item.AgileUrl ;
                        return "<a href='"+myurl+"' target=__blank>"+item.AgileID+"</a>";
                    },
                },
                { display: 'OPEN', name: 'Open',  align: 'left', width: 95,
                        render: function (record, rowindex, value, column) {html = add_color(value, column.name); return html}},
                { display: 'IN PROCESS', name: 'InProcess',  align: 'left', width: 110,
                    render: function (record, rowindex, value, column) {html = add_color(value, column.name); return html}},
                { display: 'GENERATED', name: 'Generated',  align: 'left', width: 110,
                    render: function (record, rowindex, value, column) {html = add_color(value, column.name); return html}},
                { display: 'TESTED', name: 'Tested',  align: 'left', width: 110,
                    render: function (record, rowindex, value, column) {html = add_color(value, column.name); return html}},
                { display: 'REVIEWED', name: 'Reviewed',  align: 'left', width: 95,
                    render: function (record, rowindex, value, column) {html = add_color(value, column.name); return html}},
                { display: 'INTERGRATED', name: 'Integrated',  align: 'left', width: 95,
                    render: function (record, rowindex, value, column) {html = add_color(value, column.name); return html}},
                { display: 'VALIDATED', name: 'Validated',  align: 'left', width: 95,
                    render: function (record, rowindex, value, column) {html = add_color(value, column.name); return html}},
                { display: 'ALL FILES ADDED', name: 'AllFilesAdded',  align: 'left', width: 110,
                    render: function (record, rowindex, value, column) {html = add_color(value, column.name); return html}},
                { display: 'SPKG VALIDATED', name: 'SpkgValidated',  align: 'left', width: 110,
                    render: function (record, rowindex, value, column) {html = add_color(value, column.name); return html}},
                { display: 'LOG VALIDATED', name: 'LogValidated',  align: 'left', width: 110,
                    render: function (record, rowindex, value, column) {html = add_color(value, column.name); return html}},
                { display: 'CLOSED', name: 'Closed',  align: 'left', width: 95,
                    render: function (record, rowindex, value, column) {html = add_color(value, column.name); return html}},
                ],
                onAfterShowData :function (rowdata,rowid) {
                    if (intclock==0) {load();}
                    $('[class="l-grid-row-cell-inner"]').each(function () {$(this).css('min-height',"20px");});
                },
                alternatingRow: false,
                rowHeight: 20,
                headerRowHeight: 20,
                pageSizeOptions: [10,20, 22, 25,26,30, 33,38,40,50,100,200,500],
                pageSize:30,
                enabledSort : true,
                sortName:'CreatedDate',
                sortOrder:'desc',
                url:'/pri_db/?op=flow_list&tb=jira_list&fmt=json',
                dataType: 'server',
                dataAction: 'server',
                usePager: true,
                async: true,
                scroll: true,
                checkbox:true,
                isChecked: f_isChecked,
                enabledEdit: true, //Click the line without checking 
                width: '100%',height:'100%',
            });
            $("#pageloading").hide();
            columns_all='';
            $(g.columns).each(function (i, column) {columns_all=columns_all+(columns_all?';':'')+column.name;});
            selcolumn_value = columns_all.replace('id;', '')
            f_toggle(selcolumn_value,columns_all);
            $("input[id='txtColumnName']").val(selcolumn_value);
            status_value = "Validated;Integrated;Reviewed;Tested;Generated;In Progress;Open";
            $("input[id='txtStatus']").val(status_value);
            search();
        });
        function f_isChecked(rowdata)
        {
            select_id_list = []
            if (select_ids != '')
            {
                select_id_list = select_ids.split(',')
                for (var id in select_id_list)
                {
                    if(select_id_list[id] == rowdata.id)
                    {
                        return true;
                    }
                }
            }
            return false;
        }
        
        function f_save_checkin()
        {
            var txt = ""
            var rows = g.getCheckedRows();
            $(rows).each(function ()
            {
                txt += this.id + ",";
            });
            return txt
        };
        function f_select()
        {
            var rows = g.rows;
            var select_reverse_ids = "";
            var select_list = [];
            var temp_select_list = [];
            var temp_unselect_list = [];
            
            select_reverse_ids = f_save_checkin();
            if(select_reverse_ids != '')
            {
                select_list = select_reverse_ids.split(',');
                for (var i = 0, l = rows.length; i < l; i++)
                {
                    exist_flag = 0;
                    var rowid = rows[i]['__id'];
                    obj = "tr[id^=maingrid4\\|2\\|"+rowid+"]";
                    var idstr=$(obj).attr("id");
                    var chkidstr=idstr.replace("|2|","\\|1\\|");
                    //console.log($("#"+chkidstr+">td")[0].parentElement)
                    var rowobj = g.getRowObj(rowid);
                        
                    for(var id in select_list)
                    {
                        if (select_list[id] != rows[i].id) {exist_flag = 1;}
                        else {exist_flag=0;break;}
                    }
                    if (exist_flag==1) 
                    {
                        temp_select_list.push(rows[i]);
                        $("#"+chkidstr).addClass("l-selected");
                        if (rowobj) $(rowobj).addClass("l-selected");
                    }
                    else
                    {
                        $("#"+chkidstr).removeClass("l-selected");
                        if (rowobj) $(rowobj).removeClass("l-selected");
                    }
                }
            }
            else
            {
                for (var i = 0, l = rows.length; i < l; i++)
                {   
                    temp_select_list.push(rows[i]);
                    obj = "tr[id^=maingrid4\\|2\\|"+rows[i].__id+"]";
                    var idstr=$(obj).attr("id");
                    var chkidstr=idstr.replace("|2|","\\|1\\|");
                    $("#"+chkidstr).addClass("l-selected");
                    var rowid = rows[i]['__id'];
                    var rowobj = g.getRowObj(rowid);
                    $(rowobj).addClass("l-selected");
                }
            }
            g.selected.length = 0;
            for (var i=0;i<temp_select_list.length;i++)
            {
                g.selected[g.selected.length] = temp_select_list[i];
                g.selected.length++;
            }
        };
        var select_ids='';
        function search(ctype, op) {
            select_ids = f_save_checkin();
            if ($("#txtJiraId").val() == "")
            {
                $("#txtJiraId").val('OEMPRI')
            }
            
            if ($("#txtJiraId").val().search('OEMPRI') == -1)
            {
                Key = 'OEMPRI-'+$("#txtJiraId").val()
                $("#txtJiraId").val(Key)
            }
            var params = {　
                            filter_keys:'Key__iregex,Status__in,CreatedDate__range',
                            Key:$("#txtJiraId").val(),
                            Key_op:$("#txtJiraIdOp").val(),
                            Status:$("#txtStatus").val(),
                            Status_op:$("#txtStatusOp").val(),
                            CreatedDate:$("#txtStartCreateDate").val()+';'+$("#txtEndCreateDate").val(),                   
                            CreatedDate_op:$("#txtCreatedDateOp").val(),
                            sortorder:g.options.sortOrder,
                            sortname:g.options.sortName,
                            page: g.options.page,
                            pagesize:g.options.pageSize
            };
            g.setOptions({parms : params});
            g.loadServerData(params);
            if (ctype)
                g.changePage(ctype);
        }
        function f_toggleex() {f_toggle($("#txtColumnName").val(),columns_all);search('first');}
        function f_toggle(columns_sel,columns_all)
        {
            nmes=columns_all.split(';');
            sels=columns_sel.split(';');
            
            if (sels.indexOf('id') == -1) {g.toggleCol(0, false);}
            else {g.toggleCol(0, true);}
            
            for (i=0,leni=nmes.length;i<leni;i++) {
                isshow=false;
                for (j=0,lenj=sels.length;j<lenj;j++) {
                    if (nmes[i]==sels[j]) {isshow=true;break;}
                }
                g.toggleCol(nmes[i], isshow);
            }
        }
        function f_editfield()
        {
            var rows = g.getCheckedRows();
            var txt = "";
            $(rows).each(function ()
            {
                txt += this.id + ",";
            });
            
            if (txt!='') {
                    $.ligerDialog.open({ title:'PRI_System EditField',width: 900,height: 350,url: '/pri_db/?op=editfield&tb=jira_list&fieldname=Status&id='+txt }); 
            } else {
                $.ligerDialog.warn('No Ticket selected!');
            }
        };
        function f_syncfromJira()
        {
            var txt=f_save_checkin();
            if (txt!='') {
                    $.ligerDialog.open({ title:'PRI_System Sync From Jira',width: 900,height: 350,url: '/pri_db/?op=syncfromJira_flow&tb=jira_list&id='+txt }); 
            } else {
                $.ligerDialog.warn('No Ticket selected!','Tips');
            }
        };
        function f_op_menu(obj) 
        {
            if (obj.value=='syncfromJira') {f_syncfromJira();}
            else if (obj.value=='editfield') {f_editfield();}
            else if (obj.value=='selectreverse') {f_select();}
            else {alert('Not Support Now!');}
            obj.value='';
        };
        function f_open()
        {
            $.ligerDialog.open({
                height:450,
                width: 500,
                title : 'Open window prompt',
                url: '/flow_select/select_flow_data.htm', 
                showMax: false,
                showToggle: true,
                showMin: false,
                isResize: true,
                slide: false,
                onClose :function (item, dialog) { if (this.frame.isdirty) {f_toggleex();}},
                onLoaded :function (item, dialog) { this.frame.set_dialog(this);},
                buttons:[
                    { text:'OK',
                        onclick:function (item, dialog) { 
                            dialog.frame.f_ok();
                        }}, 
                    { text: 'CLOSE', onclick: function (item, dialog) {dialog.close();}},
                    ],
                data:{
                    StatusName: $("#txtStatus").val(),
                    StatusOp: $("#txtStatusOp").val(),
                    StartCreatedDate: $("#txtStartCreateDate").val(),
                    EndCreatedDate: $("#txtEndCreateDate").val(),
                    CreatedDateOp: $("#txtCreatedDateOp").val(),
                    JiraIdName: $("#txtJiraId").val(),
                    JiraIdOp: $("#txtJiraIdOp").val(),
                    ColumnName: $("#txtColumnName").val(),
                },
            });
        }
        function add_color(data, column_name)
        {
            str = 'Stone Li,Lares Yang,Bing Huang,Mary Shan,Nicky Zheng'
            if (column_name == 'Assignee')
            {
               if (str.indexOf(data) != -1)
                {
                    var html = "<li style='background-color:#F9F900;color:red'>" + data + "</li>";
                }
                else
                {
                    var html = "<li>" + data + "</li>";
                } 
            }
            else
            {
                if (data.indexOf('*') != -1 && data.split('*')[0] != '')
                {
                    if (str.indexOf(data.split('*')[0]) != -1)
                    {
                        var html = "<li style='background-color:#F9F900'>" + data + "</li>";
                    }
                    else
                    {
                        var html = "<li style='background-color:#FFD1A4'>" + data + "</li>";
                    }
                }    
                else
                {
                    var html = "<li>"+ data +"</li>";
                }
            }
            return html
        }
        var intclock=0;
        function load() {
            intclock=self.setInterval("search()",10000);
        }
        function goodbye() {
            self.clearInterval(intclock);
        }
        var tip;
        var num = 0;
        function f_tip2(msg) {
                tip = $.ligerDialog.alert(msg,'PRI_System');
        }
    </script>
</head>
<body style="padding:6px; overflow:hidden;" onunload="goodbye()">
<form>
    <table>
    <tr>
    <td> &nbsp;
        <select id="op_menu" name="op_menu" onchange="f_op_menu(this);return false;" >
            <option value="" >Please select your operation:</option>
            <option value="selectreverse" >select Reverse</option>
            <option value="syncfromJira" >01 Sync from Jira</option>
			<option value="editfield" >04 Batch Edit</option>
        </select>
    </td>
    </tr>
    <tr>
        <td><input id="txtColumnName" type="hidden" /></td>
        <td><input id="txtJiraId" type="hidden" /></td>
        <td><input id="txtJiraIdOp" type="hidden" value="and"/></td>
        <td><input id="txtStatus" type="hidden" /></td>
        <td><input id="txtStatusOp" type="hidden" value="and"/></td>
        <td><input id="txtStartCreateDate" type="hidden" /></td>
        <td><input id="txtEndCreateDate" type="hidden" /></td>
        <td><input id="txtCreatedDateOp" type="hidden" value="and" /></td>
    </tr>
    </table>
</form>
    <div class="l-loading" style="display: block" id="pageloading">
    </div> 
    <div id="maingrid4" style="margin:0; padding:0"></div>
    <div style="display:none;">
    <!-- g data total ttt -->
    </div>    
</body>
</html>
